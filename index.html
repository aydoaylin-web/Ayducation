<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üéôÔ∏è Sch√ºlerpodcast ‚Äì Argumentation einfach erkl√§rt</title>
  <meta name="description" content="Sch√ºlerpodcast mit einfachen Erkl√§rungen, √úbungen und Beispielen. √ñffentlich abspielbar. Admin-Upload sichtbar (ohne PIN), M4A/MP3 unterst√ºtzt.">
  <style>
    :root{
      --bg:#0b1320; --panel:#0f2036; --ink:#eaf2ff; --muted:#a9bfd6; --accent:#6bdcff;
      --ok:#22c55e; --warn:#ef4444; --line:#1b2e4a; --chip:#173253; --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius: 16px; --radius-lg: 22px; --maxw: 1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 1200px at 15% 0%, #103058 0%, #0b1320 45%, #081120 100%);color:var(--ink);font:16px/1.6 "Inter", system-ui, Segoe UI, Roboto, Arial, sans-serif}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg, #27c3ff, #6bdcff);display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo svg{filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .muted{color:var(--muted)}

    .hero{margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:var(--radius-lg);padding:22px 22px 18px;box-shadow:var(--shadow)}
    .hero h2{margin:0 0 8px;font-size:22px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{background:var(--chip);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}

    .grid{display:grid;grid-template-columns: 1.3fr .7fr;gap:18px;margin-top:22px}
    @media (max-width: 880px){ .grid{grid-template-columns: 1fr;}}

    .panel{background:rgba(8,18,36,.6);border:1px solid var(--line);border-radius:var(--radius);padding:16px 16px 8px;box-shadow:var(--shadow)}
    .panel h3{margin:4px 0 12px;font-size:18px}

    .episodes{display:grid;gap:12px}
    .card{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:14px;display:grid;gap:10px}
    .title{font-weight:700}
    .meta{font-size:13px;color:var(--muted)}

    audio{width:100%;outline:none}
    audio::-webkit-media-controls-enclosure{border-radius:12px;background:rgba(255,255,255,.06)}
    audio[controls]{filter:drop-shadow(0 6px 14px rgba(0,0,0,.35))}

    .row{display:flex;gap:10px;align-items:center}
    .row > *{flex:1}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], textarea, input[type="url"], input[type="password"], input[type="file"]{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px;width:100%}
    textarea{min-height:96px;resize:vertical}
    .btn{border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{border-color:#1c3d63;background:linear-gradient(180deg,#2a83ae,#1f4b7a)}
    .btn.ghost{background:transparent}
    .danger{color:#ffd2d2}

    .tag{font-size:12px;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:3px 8px;border-radius:999px;color:var(--muted)}

    .admin{display:block;margin-top:10px}
    details{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer}

    .empty{color:var(--muted);text-align:center;padding:22px 8px;border:1px dashed var(--line);border-radius:14px}

    footer{margin:24px 0 16px;color:var(--muted);font-size:13px;text-align:center}

    /* (deaktiviertes Setup/Pin-Overlay entfernt) */
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" id="logoBox" aria-hidden="true">
          <img id="logoImg" src="" alt="Podcast Logo" style="max-width:100%;max-height:100%;display:none;border-radius:12px"/>
          <!-- Platzhalter-Icon -->
          <svg id="logoSvg" width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="10" stroke="white" opacity=".5"/>
            <path d="M8 9v6l6-3-6-3z" fill="white"/>
          </svg>
        </div>
        <div>
          <h1>Sch√ºlerpodcast</h1>
          <div class="muted">Argumentation & Er√∂rterung ‚Äì einfach erkl√§rt</div>
        </div>
      </div>
      <!-- Admin-Schalter nicht mehr n√∂tig -->
    </header>

    <section class="hero" aria-label="Podcast-Intro">
      <h2>üéß H√∂ren & Lernen</h2>
      <p class="muted">Hier findest du unseren Lernpodcast in einfacher Sprache. Dr√ºcke auf ‚ñ∂Ô∏è und h√∂re zu. Es gibt Beispiele und Mini-√úbungen.</p>
      <div class="chips">
        <span class="chip">Einfache Sprache</span>
        <span class="chip">A1/A2</span>
        <span class="chip">Deutsch als Zweitsprache</span>
        <span class="chip">Pr√ºfung: Er√∂rterung</span>
      </div>
    </section>

    <div class="grid">
      <section class="panel" aria-label="Episoden">
        <h3>Folgen</h3>
        <div id="episodes" class="episodes"></div>
        <div id="emptyState" class="empty" hidden>
          Noch keine Folgen. F√ºge im Admin-Bereich eine Datei/URL hinzu.
        </div>
      </section>

      <aside class="panel" aria-label="Infos">
        <h3>Worum geht's?</h3>
        <p>Wir erkl√§ren, wie man Argumente bildet und eine Er√∂rterung schreibt. Mit Beispielen, einfachen W√∂rtern und kurzen √úbungen.</p>
        <details>
          <summary>Tipps zum H√∂ren</summary>
          <ul>
            <li>Dr√ºcke auf Pause ‚è∏Ô∏è und beantworte Fragen im Kopf.</li>
            <li>H√∂re eine Stelle noch einmal, wenn sie schwer ist.</li>
            <li>Notiere neue W√∂rter.</li>
          </ul>
        </details>

        <details>
          <summary>Transkript (optional einblendbar)</summary>
          <p class="muted">Du kannst beim Upload ein Transkript mitgeben. Es wird hier pro Folge angezeigt.</p>
        </details>

        <!-- Admin-Bereich: IMMER SICHTBAR -->
        <div class="admin" id="admin">
          <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">
          <h3>üîí Admin ‚Äì Folge hinzuf√ºgen</h3>
          <p class="muted">Dieser Bereich ist sichtbar. F√ºr die Ver√∂ffentlichung einfach in deinem Repo lassen; Lernende k√∂nnen hier nichts speichern, au√üer sie haben Schreibrechte im Browser (nur lokal).</p>

          <hr style="border:0;border-top:1px solid var(--line);margin:12px 0">
          <h3>üé® Logo hochladen</h3>
          <input id="fLogo" type="file" accept="image/png,image/jpeg,image/svg+xml" />
          <button class="btn primary" id="saveLogo">Logo speichern</button>
          <button class="btn danger" id="deleteLogo">Logo l√∂schen</button>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Titel</label>
              <input id="fTitle" type="text" placeholder="z. B. Argument oder Er√∂rterung" />
            </div>
            <div>
              <label>Dauer (optional)</label>
              <input id="fLen" type="text" placeholder="z. B. 10:32" />
            </div>
          </div>

          <label style="margin-top:8px;display:block">Audio-Quelle (URL, .mp3 oder .m4a)</label>
          <div class="row">
            <input id="fUrl" type="url" placeholder="https://‚Ä¶/dein-podcast.m4a (oder .mp3, CORS erlaubt)" />
          </div>

          <div style="display:flex;align-items:center;gap:10px;margin:8px 0">
            <div style="flex:1;height:1px;background:var(--line)"></div>
            <span class="tag">oder lokale Datei</span>
            <div style="flex:1;height:1px;background:var(--line)"></div>
          </div>

          <!-- WICHTIG: M4A/MP4 akzeptieren -->
          <input id="fFile" type="file" accept="audio/m4a,audio/mp4,audio/x-m4a,audio/aac,audio/mpeg" />

          <label style="margin-top:8px;display:block">Kurzbeschreibung (optional)</label>
          <textarea id="fDesc" placeholder="Worum geht's in dieser Folge?"></textarea>

          <label style="margin-top:8px;display:block">Transkript (optional)</label>
          <textarea id="fTxt" placeholder="Text, der beim H√∂ren mitgelesen werden kann."></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="addEpisode">Folge speichern</button>
            <button class="btn" id="exportBtn" title="Sicherung als JSON">Export</button>
            <button class="btn danger" id="wipeAll" title="Alle Folgen l√∂schen">Alles l√∂schen</button>
          </div>
          <p class="muted" style="margin-top:6px">Hinweis: Metadaten in localStorage. Lokale Dateien (Upload) in IndexedDB (nur auf diesem Ger√§t). F√ºr globale Ver√∂ffentlichung: Audio ins Repo (z. B. <code>/media/</code>) und als URL eintragen.</p>
        </div>
      </aside>
    </div>

    <footer>
      ¬© <span id="year"></span> Sch√ºlerpodcast ¬∑ √ñffentliche Abspielfunktion ¬∑ Admin sichtbar
    </footer>
  </div>

  <script>
    // ======= Keys & Helpers =======
    const STORE_KEY  = 'schuelerpodcast.v1';
    const LOGO_KEY   = 'schuelerpodcast.logo';

    const $  = (sel, p=document) => p.querySelector(sel);
    const $$ = (sel, p=document) => Array.from(p.querySelectorAll(sel));

    function fmtDate(ts){
      try{ return new Date(ts).toLocaleDateString('de-DE', {year:'numeric', month:'short', day:'2-digit'}) }catch(e){ return '' }
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    // ======= Persistenz (localStorage) =======
    const store = {
      get(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || { episodes: [] } }catch(e){ return { episodes: [] } } },
      set(data){ localStorage.setItem(STORE_KEY, JSON.stringify(data)); },
      clear(){ localStorage.removeItem(STORE_KEY); }
    };

    // ======= IndexedDB f√ºr lokale Audiodateien (M4A/MP3) =======
    const DB_NAME = 'schuelerpodcast_db';
    const DB_STORE = 'files';
    function idbOpen(){
      return new Promise((res, rej)=>{
        const rq = indexedDB.open(DB_NAME, 1);
        rq.onupgradeneeded = () => rq.result.createObjectStore(DB_STORE);
        rq.onsuccess = () => res(rq.result);
        rq.onerror = () => rej(rq.error);
      });
    }
    async function idbPut(key, blob){
      const db = await idbOpen();
      return new Promise((res, rej)=>{
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).put(blob, key);
        tx.oncomplete = () => res();
        tx.onerror = () => rej(tx.error);
      });
    }
    async function idbGet(key){
      const db = await idbOpen();
      return new Promise((res, rej)=>{
        const tx = db.transaction(DB_STORE, 'readonly');
        const r = tx.objectStore(DB_STORE).get(key);
        r.onsuccess = () => res(r.result);
        r.onerror = () => rej(r.error);
      });
    }
    async function idbClear(){
      const db = await idbOpen();
      return new Promise((res, rej)=>{
        const tx = db.transaction(DB_STORE, 'readwrite');
        const r = tx.objectStore(DB_STORE).clear();
        r.onsuccess = () => res();
        r.onerror = () => rej(r.error);
      });
    }

    // ======= MIME-Helfer =======
    function inferMimeFromUrl(u=''){
      const url = (u||'').toLowerCase().split('?')[0];
      if(url.endsWith('.mp3')) return 'audio/mpeg';
      if(url.endsWith('.m4a') || url.endsWith('.mp4')) return 'audio/mp4';
      return ''; // Browser r√§t
    }

    // ======= Rendering =======
    async function render(){
      const data = store.get();
      const list = $('#episodes');
      list.innerHTML = '';
      if(!data.episodes.length){ $('#emptyState').hidden = false; return }
      $('#emptyState').hidden = true;

      for(let idx=0; idx<data.episodes.length; idx++){
        const ep = data.episodes[idx];
        const card = document.createElement('article');
        card.className = 'card';

        const isLocal = ep.src && ep.src.startsWith('idb://');
        const initialSrc = isLocal ? '' : (ep.src || '');
        const mime      = ep.mime || inferMimeFromUrl(ep.src) || 'audio/mp4'; // default gut f√ºr m4a

        card.innerHTML = `
          <div class="row" style="align-items:flex-start">
            <div style="flex:1">
              <div class="title">${escapeHtml(ep.title || 'Ohne Titel')}</div>
              <div class="meta">${ep.length ? `${escapeHtml(ep.length)} ¬∑ `:''}${fmtDate(ep.ts || Date.now())}</div>
            </div>
          </div>
          <audio controls controlslist="nodownload noplaybackrate noremoteplayback" preload="none">
            <source src="${initialSrc}" type="${mime}" />
            Dein Browser kann dieses Audio nicht abspielen.
          </audio>
          ${ep.desc ? `<div>${escapeHtml(ep.desc)}</div>`:''}
          ${ep.txt ? `<details><summary>Transkript anzeigen</summary><div style="white-space:pre-wrap">${escapeHtml(ep.txt)}</div></details>`:''}
          <div class="meta">Quelle: ${isLocal ? 'Lokal (persistenter Ger√§tespeicher)' : 'URL'}</div>
        `;
        list.appendChild(card);

        if(isLocal){
          const key = ep.src.slice(6);
          try{
            const blob = await idbGet(key);
            if(blob){
              const url = URL.createObjectURL(blob);
              const audio = card.querySelector('audio');
              const source = audio.querySelector('source');
              source.src = url;
              // Setze type auf Blob.type, falls vorhanden (z. B. audio/mp4)
              if(blob.type) source.type = blob.type;
              audio.load();
            } else {
              card.querySelector('.meta').insertAdjacentHTML('beforeend',' ¬∑ ‚ö†Ô∏è Audiodatei nicht gefunden');
            }
          }catch(e){
            card.querySelector('.meta').insertAdjacentHTML('beforeend',' ¬∑ ‚ö†Ô∏è Fehler beim Laden');
          }
        }
      }
    }

    // ======= Logo-Upload & Anzeige =======
    $('#saveLogo').addEventListener('click', async ()=>{
      const file = $('#fLogo').files[0];
      if(!file){ alert('Bitte eine Bilddatei ausw√§hlen.'); return; }
      const reader = new FileReader();
      reader.onload = ()=>{
        localStorage.setItem(LOGO_KEY, reader.result); // Base64 speichern
        renderLogo();
        alert('Logo gespeichert.');
      };
      reader.readAsDataURL(file);
    });

    function renderLogo(){
      const data = localStorage.getItem(LOGO_KEY);
      const img = $('#logoImg');
      const svg = $('#logoSvg');
      if(!img || !svg) return;
      if(data){
        img.src = data;
        img.style.display = 'block';
        svg.style.display = 'none';
      } else {
        img.style.display = 'none';
        svg.style.display = 'block';
      }
    }

    $('#deleteLogo').addEventListener('click', ()=>{
      if(confirm('M√∂chtest du das Logo wirklich l√∂schen?')){
        localStorage.removeItem(LOGO_KEY);
        renderLogo();
        alert('Logo gel√∂scht.');
      }
    });

    // ======= Upload / Hinzuf√ºgen =======
    $('#addEpisode').addEventListener('click', async ()=>{
      const title = $('#fTitle').value.trim();
      const len   = $('#fLen').value.trim();
      const url   = $('#fUrl').value.trim();
      const desc  = $('#fDesc').value.trim();
      const txt   = $('#fTxt').value.trim();
      const file  = $('#fFile').files[0];

      if(!title){ alert('Bitte Titel eingeben.'); return }

      let src = '';
      let local = false;
      let mime = '';

      if(url){
        src  = url;                           // direkte URL (mp3 oder m4a)
        mime = inferMimeFromUrl(url) || '';   // Browser darf raten
      } else if(file){
        const key = `audio_${Date.now()}_${Math.random().toString(36).slice(2)}`;
        await idbPut(key, file);
        src  = `idb://${key}`;
        local = true;
        // File.type z. B. "audio/mp4" f√ºr m4a, "audio/mpeg" f√ºr mp3
        mime = file.type || '';
      } else {
        alert('Bitte Audio-URL einf√ºgen oder Datei ausw√§hlen.');
        return;
      }

      const data = store.get();
      data.episodes.unshift({ title, length: len, src, mime, desc, txt, local, ts: Date.now() });
      store.set(data);

      ['#fTitle','#fLen','#fUrl','#fDesc','#fTxt'].forEach(s=> $(s).value = '');
      $('#fFile').value = '';

      await render();
      alert('Folge gespeichert.');
    });

    // ======= Export / Wipe =======
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(store.get(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'podcast-daten.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $('#wipeAll').addEventListener('click', async ()=>{
      if(confirm('Wirklich alle Folgen und lokale Dateien l√∂schen?')){
        store.clear();
        await idbClear();
        render();
      }
    });

    // ======= Init =======
    $('#year').textContent = new Date().getFullYear();

    (async function init(){
      await render();
      renderLogo();
    })();
  </script>
</body>
</html>
